---
output: word_document
---
```{r}
#library(lubridate)
#library(lazyeval)
install.packages('plotly', repos = 'http://cran.us.r-project.org')
library(ggplot2)
library(GGally)
```


```{r echo=TRUE}
checkNaFunction <- function(houseData){
naColumns <- c()
#checking NA for each columns
for(i in 1:ncol(houseData)) {
  #cat(sprintf("Checking NA: %s \n", colnames(houseData)[i]))
  if(length(which(is.na(houseData[,i]))) > 0){
    #cat(sprintf("There is NA: %s \n" , colnames(houseData)[i]))
    naColumns <- c(naColumns, colnames(houseData)[i])
  }
}
return(naColumns)
}

```


```{r echo=TRUE}
bucketByColumn <- function(houseData,i){
minP <- min(as.numeric(houseData[,i]))
maxP <- max(as.numeric(houseData[,i]))
rangeP <- range(as.numeric(houseData[,i]))
rangeP
cat(sprintf("Min-Max value for: %s , MAX: %d, MIN: %d \n", colnames(houseData)[i], minP, maxP))
}

```



```{r echo=TRUE}
analysis <- function(houseData, i, labels, plotLog){
  plot(houseData$price~houseData[,i],main = labels[1],xlab = labels[2],ylab = labels[3], col=(c("gold","darkgreen")))
  
  plot(houseData[,i],log(houseData$price), main=cat(labels[1]), xlab=cat(labels[2]), ylab=cat("Log of ",labels[3]), col=(c("gold","darkgreen")))
  
  if(plotLog=='Y'){
    plot(log(houseData[,i]),log(houseData$price), main=cat("Log ",labels[1]), xlab=cat("Log of ",labels[2]), ylab=cat("Log of ",labels[3]), col=(c("gold","darkgreen")))
  }
  
  hist(houseData[,i],main = labels[1],xlab = labels[2],ylab = labels[3],col=(c("gold","darkgreen")))

  boxplot(houseData[,i],main = labels[1],col=(c("gold","darkgreen")))
  
  cor(houseData[,i],houseData$price)
}

```


#Data Importing And Cleaning
```{r echo=TRUE}
houseData <- read.csv("file:///G:/Ryerson-BigData/capstone-R/CKME-136/data/kc_house_data.csv")
head(houseData)
colnames(houseData)
naColumns <- checkNaFunction(houseData)
if(length(naColumns)>0){
  cat("Found NA Colums:")
  for(i in 1:length(naColumns)) {
    cat(sprintf("%s,", colnames(houseData)[i]))
  }
}

#houseData$date<-(substr(houseData$date, 1, 8))
#houseData$date<- ymd(houseData$date)
#houseData$date<-as.numeric(as.Date(houseData$date, origin = "1900-01-01"))

# Here we conclude that this data does not hold any column with NA.
bucketByColumn(houseData,3)

```

#Price with other attributes
```{r echo=TRUE}
## verify the relationship between price, bedrooms, bathrooms, sqft_living and sqft lot
plot1 <- ggpairs(data=houseData, columns=3:7, mapping = aes(color = "dark green"),              axisLabels="show")
plot1

## verify the relationship between price, floors, waterfront, view, condition and grade
plot2 <- ggpairs(data=houseData, columns=c(3,8:12),
               mapping = aes(color = "dark green"),
               axisLabels="show")
plot2

## verify the relationship between price, yr built, lat and long
plot3 <- ggpairs(data=houseData, columns=c(3,15,18,19),
              mapping = aes(color = "dark green"),
              axisLabels="show")
plot3

```


##Correlation among all the variables
```{r echo=TRUE}
#Only sqft_living & sqft_above,sqft_living & grade,sqft_living & bathrooms have good correlation between them
#Remove the columns which does not hold any significance in predicing house price
houseData$date <- NULL
houseData$id <- NULL
cor(houseData)
# we can see that zip-code has very weak co-orelation -0.053202854, so let us remove it
houseData$zipcode <- NULL
houseData <- read.csv("file:///G:/Ryerson-BigData/capstone-R/CKME-136/data/kc_house_data.csv")

```

#Now Let us do analysis of price with all other variables
#Bedroom  Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,4)
analysis(houseData,4,c('Bedrooms vs. price','Bedrooms', 'Price of House'), 'Y')
#*******Removing the outliers
#Since more than 7 bedrooms are very rare.Also it's the outlier for my model.
#I  have removed  the outlier data.
houseData<-subset(houseData,bedrooms>=1 & bedrooms<=7)
#*******Once we removed the outliers, again get the analysis
analysis(houseData,4,c('Bedrooms vs. price','Bedrooms', 'Price of House'), 'Y')
bucketByColumn(houseData,4)
## here we found that log of bedroom give better performance.
```


#Bathroom Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,5)
analysis(houseData,5,c('Bathrooms vs. price','Bathrooms', 'Price of House'), 'Y')
## Price vs. Bathrooms, here we can find good correlation, as number of bahtrooms increases, price increases as well, with one expection in when bathroom=7
#*******Removing the outliers
#More than 4 bathrooms are very rare in this data.So I am removing it.
houseData<-subset(houseData,bathrooms>=1 & bathrooms<=4)
analysis(houseData,5,c('Bathrooms vs. price','Bathrooms', 'Price of House'), 'Y')
bucketByColumn(houseData,5)
## here we found that log of bathrooms give better performance.
```


#SQFT Living  Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,6)
analysis(houseData,6,c('Living-Sqft vs. price','Living-Sqft', 'Price of House'), 'Y')
## Price vs. Sqft_living ->> Nice correlation, as sqft increases, price increases as well.
#*******Removing the outliers
houseData<-subset(houseData,sqft_living >1000 & sqft_living<=4000)
analysis(houseData,6,c('Living-Sqft vs. price','Living-Sqft', 'Price of House'), 'Y')
bucketByColumn(houseData,6)

## Price vs. Sqft_living ->> Nice correlation, as sqft increases, price increases as well.

```


## SQFT_LOT Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,7)
analysis(houseData,7,c('LotSize vs. price','LotSize', 'Price of House'), 'Y')
#*******Removing the outliers
houseData<-subset(houseData,sqft_lot>=0 & sqft_lot<=25000)
analysis(houseData,7,c('LotSize vs. price','LotSize', 'Price of House'), 'Y')
bucketByColumn(houseData,7)
```

## FLOOR Vs Price analysis
```{r echo=TRUE}
analysis(houseData,8,c('Floors vs. price','Floor', 'Price of House'), 'Y')
#bucketByColumn(houseData,8)
```

## SQFT_LOT Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,9)
analysis(houseData,9,c('WaterFront vs. price','WaterFront', 'Price of House'), 'Y')
#*******Removing the outliers
houseData<-subset(houseData,sqft_lot>=0 & sqft_lot<=25000)
analysis(houseData,9,c('WaterFront vs. price','WaterFront', 'Price of House'), 'Y')
bucketByColumn(houseData,9)
```


## View Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,10)
analysis(houseData,10,c('View vs. price','View', 'Price of House'), 'Y')
## Price vs. View ->> Nice correlation, view increases [median of bar plot], price increases as well
#*******Removing the outliers
analysis(houseData,10,c('View vs. price','View', 'Price of House'), 'Y')
bucketByColumn(houseData,10)
```


##CONDITION Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,11)
analysis(houseData,11,c('Condition vs. price','condition', 'Price of House'), 'Y')
#*******Removing the outliers
houseData<-subset(houseData,condition>=3& condition<=5)
analysis(houseData,11,c('Condition vs. price','condition', 'Price of House'), 'Y')
bucketByColumn(houseData,11)
```


##Grade Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,12)
analysis(houseData,12,c('Grade vs. price','Grade', 'Price of House'), 'Y')
## Price vs. Grade ->> Nice correlation, grade increases [median of bar plot], price increases as well
#*******Removing the outliers
#Most of the houses grades are between 6-10 
houseData<-subset(houseData,grade >= 6 & grade<=10)
analysis(houseData,12,c('Grade vs. price','Grade', 'Price of House'), 'Y')
bucketByColumn(houseData,12)
#grade is good without log 
```

#SQFT_ABOVE Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,13)
analysis(houseData,13,c('MainHouseSize vs. price','MainHouseSize', 'Price of House'), 'Y')
#*******Removing the outliers
houseData<-subset(houseData,sqft_above >=500 & sqft_above<=3500)
analysis(houseData,13,c('MainHouseSize vs. price','MainHouseSize', 'Price of House'), 'Y')
bucketByColumn(houseData,13)

```


##SQFT_BASEMENT Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,14)
analysis(houseData,14,c('BasementSize vs. price','BasementSize', 'Price of House'), 'Y')
#*******Removing the outliers
houseData<-subset(houseData,sqft_basement >=0 & sqft_basement<=1500)
analysis(houseData,14,c('BasementSize vs. price','BasementSize', 'Price of House'), 'Y')
bucketByColumn(houseData,14)
```


#YR_BUILT Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,15)
analysis(houseData,15,c('YearBuilt vs. price','YearBuilt', 'Price of House'), 'Y')
#*******Removing the outliers
#In our data some records are too old..I just removed that data from my model.
#Because It doesn't make any sense to keep more than 100 years house in our model
houseData<-subset(houseData,yr_built>=1950& yr_built<=2015)
analysis(houseData,15,c('YearBuilt vs. price','YearBuilt', 'Price of House'), 'Y')
bucketByColumn(houseData,15)
```

#YR_BUILT Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,16)
analysis(houseData,16,c('YearRenovated vs. price','YearRenovated', 'Price of House'), 'Y')
#*******Removing the outliers
#In our data some records are too old..I just removed that data from my model.
#Because It doesn't make any sense to keep more than 100 years house in our model
houseData<-subset(houseData,yr_renovated>=1950& yr_renovated<=2015)
analysis(houseData,16,c('YearRenovated vs. price','YearRenovated', 'Price of House'), 'Y')
bucketByColumn(houseData,16)
```


#ZIPCODE Vs Price analysis
```{r echo=TRUE}
analysis(houseData,17,c('ZipCode vs. price','ZipCode', 'Price of House'), 'Y')
```



##LAT Vs Price analysis
```{r echo=TRUE}

analysis(houseData,18,c('Latitude vs. price','latitude', 'Price of House'), 'N')
## Price vs. Lat ->> This is more like a normal dist relationship, price peaks around when lat= 47.64 and declines afterwards, but this can be modeled easily. I would say Lat explains the price as well.
#*******Removing the outliers
houseData<-subset(houseData,lat>=47.3)
analysis(houseData,18,c('Latitude vs. price','latitude', 'Price of House'), 'N')
```

## LONG Vs Price analysis
```{r echo=TRUE}
analysis(houseData,19,c('Longitude vs. price','Longitude', 'Price of House'), 'N')
#*******Removing the outliers
houseData<-subset(houseData,long>=-122.4 & long < -121.8)
analysis(houseData,19,c('Longitude vs. price','Longitude', 'Price of House'), 'N')
```



## SQFT_LIVING15 Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,20)
analysis(houseData,20,c('sqft_living15 vs. price','sqft_living15', 'Price of House'), 'Y')

```

##SQFT_LOT15 Vs Price analysis
```{r echo=TRUE}
bucketByColumn(houseData,21)
analysis(houseData,21,c('sqft_lot15 vs. price','sqft_lot15', 'Price of House'), 'Y')
#*******Removing the outliers
houseData<-subset(houseData,sqft_lot15>=0 & sqft_lot<=20000)
analysis(houseData,21,c('sqft_lot15 vs. price','sqft_lot15', 'Price of House'), 'Y')
bucketByColumn(houseData,21)

```

##Correlation among all the variables
```{r echo=TRUE}
#*******Only sqft_living & sqft_above,sqft_living & grade,sqft_living & bathrooms have good correlation between them
houseData$date <- NULL
houseData$id <- NULL
cor(houseData)

```

```{r echo=TRUE}
#since no any variable is highly correlated with each other
houseData$floors<-NULL
houseData$date<-NULL
str(houseData)

colnames(houseData)
set.seed(1)
for(i in seq(from=0.6, to=0.9, by=0.05)){
  rn_train <- sample(nrow(houseData),floor(nrow(houseData)*i))
  train <- houseData[rn_train,colnames(houseData)]
  test <- houseData[-rn_train,colnames(houseData)]
  lm.price<-lm(price~.,data = train)
  prediction <- predict(lm.price,newdata = test)
  training_data_prediction = fitted(lm.price)
  training_rmse = sqrt(sum((training_data_prediction-train$price)^2)/nrow(train))
  testing_rmse = sqrt(sum((prediction - test$price)^2)/nrow(test))
  cat("\ntraining_rmse:",training_rmse)
  cat("\ntesting_rmse:",testing_rmse)
  print(lm.price)
}

```

